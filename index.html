<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Physics Vector-Quest üöÄ Interactivo</title>
    
    <!-- BIBLIOTECAS EXTERNAS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <!-- Tone.js para efectos de sonido generados por c√≥digo -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <script>
        MathJax = {
            tex: { inlineMath: [['$', '$']] },
            svg: { fontCache: 'global' }
        };
    </script>
    <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>

    <!-- ESTILOS CSS -->
    <style>
        :root {
            --primary-color: #00faff; --secondary-color: #ff00ff;
            --background-color: #0a0a1f; --text-color: #ffffff;
            --success-color: #00ff8b; --error-color: #ff3b3b;
        }
        html { scroll-behavior: smooth; }
        body { margin: 0; padding: 0; width: 100%; min-height: 100%; font-family: 'Poppins', sans-serif; background: var(--background-color); color: var(--text-color); overflow-x: hidden; }
        .font-orbitron { font-family: 'Orbitron', sans-serif; }
        .game-container { width: 100%; min-height: 100vh; display: flex; flex-direction: column; background: var(--background-color); position: relative; }
        canvas#gameCanvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; opacity: 0.9; cursor: default; }
        .game-content { position: relative; z-index: 10; display: flex; flex-direction: column; flex-grow: 1; width: 100%; align-items: center; }
        .content-wrapper { display: flex; flex-direction: column; justify-content: center; align-items: center; flex-grow: 1; width: 100%; padding: 20px 0; }
        .stats-bar { font-family: 'Orbitron', sans-serif; color: var(--primary-color); text-shadow: 0 0 5px var(--primary-color); background: rgba(10, 10, 31, 0.8); backdrop-filter: blur(5px); border-bottom: 1px solid rgba(0, 250, 255, 0.3); padding: 10px 15px; display: flex; justify-content: space-around; align-items: center; flex-wrap: wrap; gap: 10px 15px; width: 100%; flex-shrink: 0; position: sticky; top: 0; z-index: 20; }
        .stat { display: flex; align-items: center; gap: 8px; font-size: 0.9rem; }
        #quiz-area { display: flex; flex-direction: column; align-items: center; justify-content: center; width: 95%; max-width: 800px; text-align: center; }
        #question-container { background: rgba(10, 10, 31, 0.7); border: 1px solid var(--primary-color); box-shadow: 0 0 15px rgba(0, 250, 255, 0.5); border-radius: 10px; padding: 20px; margin-bottom: 25px; width: 100%; }
        #question-text { font-size: 1.2rem; line-height: 1.6; color: var(--text-color); min-height: 70px; }
        #options-container { display: grid; grid-template-columns: 1fr; gap: 15px; width: 100%; }
        .option-button { background: transparent; border: 2px solid var(--primary-color); color: var(--primary-color); width: 100%; padding: 15px; font-size: 1rem; cursor: pointer; border-radius: 8px; transition: all 0.2s ease-in-out; text-shadow: 0 0 3px var(--primary-color); }
        .option-button:not([disabled]):hover { background-color: var(--primary-color); color: var(--background-color); box-shadow: 0 0 20px var(--primary-color); }
        .option-button.correct { background-color: var(--success-color); border-color: var(--success-color); color: var(--background-color); text-shadow: none; }
        .option-button.incorrect { background-color: var(--error-color); border-color: var(--error-color); color: var(--background-color); text-shadow: none; opacity: 0.7; }
        .option-button:disabled { cursor: not-allowed; opacity: 0.6; }
        .controls-bar { font-family: 'Orbitron', sans-serif; background: rgba(10, 10, 31, 0.8); backdrop-filter: blur(5px); border-top: 1px solid rgba(0, 250, 255, 0.3); padding: 15px; display: flex; justify-content: center; align-items: center; flex-wrap: wrap; gap: 15px; width: 100%; flex-shrink: 0; z-index: 20; position: sticky; bottom: 0;}
        .game-button { font-family: 'Orbitron', sans-serif; background: transparent; color: var(--secondary-color); border: 2px solid var(--secondary-color); border-radius: 8px; padding: 10px 20px; cursor: pointer; transition: all 0.3s ease; text-shadow: 0 0 5px var(--secondary-color); font-size: 0.9rem; }
        .game-button:hover, .game-button:active { background: var(--secondary-color); color: var(--text-color); box-shadow: 0 0 15px var(--secondary-color); }
        .game-button:disabled { border-color: #555; color: #555; cursor: not-allowed; text-shadow: none; box-shadow: none; background: transparent; }
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.85); align-items: center; justify-content: center; backdrop-filter: blur(8px); padding: 15px; }
        .modal-content { background: rgba(20, 20, 45, 0.95); border: 2px solid var(--primary-color); padding: 25px; border-radius: 15px; text-align: center; width: 100%; max-width: 600px; color: var(--text-color); box-shadow: 0 0 30px rgba(0, 250, 255, 0.6); max-height: 90vh; overflow-y: auto; }
        .modal-content h2 { font-family: 'Orbitron', sans-serif; color: var(--primary-color); font-size: 1.8rem; margin-bottom: 15px; text-shadow: 0 0 10px var(--primary-color); }
        .modal-content p { font-size: 1rem; line-height: 1.7; margin-bottom: 20px; }
        #solution-container, #curiosity-container, #final-message-container { margin-top: 20px; padding-top: 15px; border-top: 1px solid rgba(0, 250, 255, 0.3); text-align: left; font-size: 1rem; }
        #solution-container h4, #curiosity-container h4, #final-message-container h4 { font-family: 'Orbitron', sans-serif; color: var(--primary-color); margin-bottom: 10px; }
        .topic-selection-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 10px; margin: 20px 0; }
        .checkbox-container { display: flex; align-items: center; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 5px; cursor: pointer; }
        .checkbox-container input { display: none; }
        .checkbox-container .checkmark { width: 20px; height: 20px; border: 2px solid var(--primary-color); border-radius: 4px; margin-right: 10px; position: relative; }
        .checkbox-container input:checked + .checkmark::after { content: '‚úì'; color: var(--primary-color); position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-weight: bold; }
        .footer { font-family: 'Orbitron', sans-serif; width: 100%; padding: 15px; text-align: center; color: var(--primary-color); text-shadow: 0 0 5px var(--primary-color); background: rgba(10, 10, 31, 0.8); border-top: 1px solid rgba(0, 250, 255, 0.3); z-index: 15; }
        @media (min-width: 640px) { .stat { font-size: 1rem; } .game-button { font-size: 1rem; padding: 12px 25px; } #question-text { font-size: 1.5rem; } .option-button { font-size: 1.1rem; } .modal-content h2 { font-size: 2.5rem; } .modal-content p { font-size: 1.2rem; } #options-container { grid-template-columns: repeat(2, 1fr); } #question-container { padding: 30px; } .modal-content { padding: 40px; } }
    </style>
</head>

<body>
    <div class="game-container">
        <canvas id="gameCanvas"></canvas>
        <div id="stats-bar" class="stats-bar" style="display: none;">
            <div class="stat">üïπÔ∏è Nivel: <span id="level-display">1</span></div>
            <div class="stat">‚ù§Ô∏è Vidas: <span id="lives-display">5</span></div>
            <div class="stat">üéØ Puntos: <span id="score-display">0</span></div>
            <div class="stat">üìà Progreso: <span id="progress-display">0/10</span></div>
            <div class="stat">‚≠ê Nota: <span id="grade-display">0.0</span></div>
        </div>
        <div class="game-content">
            <div class="content-wrapper">
                <div id="quiz-area" style="display: none;">
                    <div id="question-container"><p id="question-text"></p></div>
                    <div id="options-container"></div>
                </div>
                <div id="start-screen">
                    <div class="modal-content">
                        <h2 class="font-orbitron">CONTROL DE MISI√ìN</h2>
                        <p>Selecciona los temas para tu sesi√≥n de entrenamiento y el nivel de dificultad.</p>
                        <h3 class="font-orbitron text-lg text-primary-color mt-4">TEMAS</h3>
                        <div id="topic-selection-grid" class="topic-selection-grid"></div>
                        <h3 class="font-orbitron text-lg text-primary-color mt-4">NIVEL</h3>
                        <div id="level-selection">
                            <button class="game-button level-btn" data-level="1">Nivel 1</button>
                            <button class="game-button level-btn" data-level="2">Nivel 2</button>
                            <button class="game-button level-btn" data-level="3">Nivel 3</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="controls-bar" class="controls-bar" style="display: none;">
            <button id="pause-button" class="game-button">Pausa ‚è∏Ô∏è</button>
            <button id="help-button" class="game-button">Ayuda ‚ùì</button>
            <button id="restart-button" class="game-button">Reiniciar üîÑ</button>
        </div>
        <footer class="footer">Autor: Msc. N√©stor Fabio Montoya en la nave Gemini üöÄ</footer>
    </div>

    <!-- ========= MODALES ========= -->
    <div id="feedback-modal" class="modal"><div class="modal-content"><h2 id="feedback-title" class="font-orbitron"></h2><p id="feedback-text"></p><div id="solution-container"></div><button onclick="hideFeedbackModal()" class="game-button" style="margin-top: 20px;">Siguiente Pregunta</button></div></div>
    <div id="curiosity-modal" class="modal"><div class="modal-content"><h2 class="font-orbitron">Dato Curioso üßë‚ÄçüöÄüî≠</h2><div id="curiosity-container"></div><button onclick="hideCuriosityModal()" class="game-button" style="margin-top: 20px;">¬°Entendido!</button></div></div>
    <div id="help-modal" class="modal"><div class="modal-content"><h2 class="font-orbitron">Manual del Piloto</h2><div style="text-align: left; font-size: 0.9rem; line-height: 1.8;"><p><strong>üöÄ Misi√≥n:</strong> Responde preguntas de f√≠sica. ¬°Cada error cuesta una vida!</p><p><strong>üåå Exploraci√≥n:</strong> La nave viaja sola. Choca con meteoritos para descubrir datos curiosos y pistas.</p><p><strong>‚ù§Ô∏è Vidas:</strong> Empiezas con 5. ¬°No las pierdas!</p></div><button onclick="document.getElementById('help-modal').style.display = 'none'" class="game-button" style="margin-top: 30px;">¬°Entendido!</button></div></div>
    <div id="pause-modal" class="modal"><div class="modal-content"><h2 class="font-orbitron">Juego en Pausa</h2><p>T√≥mate un respiro. ¬°El universo esperar√°!</p><button onclick="togglePause()" class="game-button">Continuar Misi√≥n ‚ñ∂Ô∏è</button></div></div>
    <div id="end-level-modal" class="modal"><div class="modal-content"><h2 id="end-level-title" class="font-orbitron"></h2><p id="end-level-text"></p><p id="end-level-stats"></p><div id="final-message-container"></div><button id="end-level-button" class="game-button">Continuar</button></div></div>
    <div id="confirm-modal" class="modal"><div class="modal-content"><h2 id="confirm-title" class="font-orbitron">¬øEst√°s seguro?</h2><p id="confirm-text">Perder√°s todo tu progreso actual.</p><div class="flex justify-center gap-4 mt-4"><button onclick="document.getElementById('confirm-modal').style.display = 'none'" class="game-button">Cancelar</button><button onclick="location.reload()" class="game-button" style="border-color: var(--error-color); color: var(--error-color);">S√≠, reiniciar</button></div></div></div>

    <script>
    // =======================================================================
    //  BLOQUE 1: BANCO DE PREGUNTAS Y CONFIGURACI√ìN
    // =======================================================================
    const questions = [
        { text: "¬øCu√°l es una magnitud escalar?", options: ["Velocidad", "Temperatura", "Aceleraci√≥n", "Fuerza"], correct: 1, difficulty: 1, topic: 'magnitudes', solution: "La temperatura es escalar: se define con un n√∫mero y unidad (ej. 25 ¬∞C), sin direcci√≥n." },
        { text: "¬øUnidad de longitud en el SI?", options: ["Km", "Cm", "Metro", "Milla"], correct: 2, difficulty: 1, topic: 'si', solution: "La unidad fundamental de longitud en el Sistema Internacional (SI) es el metro (m)." },
        { text: "La velocidad es una magnitud...", options: ["Escalar", "Vectorial", "Fundamental", "Adimensional"], correct: 1, difficulty: 1, topic: 'magnitudes', solution: "La velocidad es vectorial: requiere magnitud (rapidez) y direcci√≥n." },
        { text: "El camino de un objeto al moverse es la:", options: ["Desplazamiento", "Posici√≥n", "Trayectoria", "Referencia"], correct: 2, difficulty: 1, topic: 'cinematica', solution: "La trayectoria es la l√≠nea o curva que un cuerpo describe durante su movimiento." },
        { text: "El cambio de posici√≥n de un cuerpo es el...", options: ["Espacio recorrido", "Desplazamiento", "Vector nulo", "Movimiento"], correct: 1, difficulty: 2, topic: 'cinematica', solution: "El desplazamiento es el vector que une la posici√≥n inicial con la final." },
        { text: "Un coche a 20 m/s constantes, ¬øqu√© distancia recorre en 10 s? ($x_o=0$)", options: ["200 m", "2 m", "30 m", "2000 m"], correct: 0, difficulty: 1, topic: 'mru', solution: "F√≥rmula: $x = x_o + v \\cdot t \\rightarrow x = 0 + 20 \\cdot 10 = 200 \\, m$" },
        { text: "Un atleta corre de $x_o=10m$ a $x=50m$ en 8s. ¬øSu velocidad media?", options: ["8 m/s", "5 m/s", "7.5 m/s", "6.25 m/s"], correct: 1, difficulty: 2, topic: 'mru', solution: "F√≥rmula: $v = \\frac{x - x_o}{t} \\rightarrow v = \\frac{50 - 10}{8} = 5 \\, m/s$" },
        { text: "Una moto viaja a 15 m/s. ¬øTiempo para recorrer 300 m? ($x_o=0$)", options: ["15 s", "30 s", "20 s", "4500 s"], correct: 2, difficulty: 2, topic: 'mru', solution: "F√≥rmula: $t = \\frac{x - x_o}{v} \\rightarrow t = \\frac{300}{15} = 20 \\, s$" },
        { text: "Un tren viaja a 30 m/s por 5s. Si su posici√≥n final es 200m, ¬øcu√°l era su $x_o$?", options: ["100 m", "150 m", "-50 m", "50 m"], correct: 3, difficulty: 3, topic: 'mru', solution: "F√≥rmula: $x_o = x - v \\cdot t \\rightarrow x_o = 200 - (30 \\cdot 5) = 50 \\, m$" },
        { text: "Un cohete parte del reposo y acelera a $10 \\, m/s^2$. ¬øVelocidad tras 4 s?", options: ["40 m/s", "2.5 m/s", "14 m/s", "400 m/s"], correct: 0, difficulty: 1, topic: 'mrua', solution: "F√≥rmula: $v = v_o + a \\cdot t \\rightarrow v = 0 + 10 \\cdot 4 = 40 \\, m/s$"},
        { text: "Un ciclista aumenta su velocidad de 5 m/s a 15 m/s en 4s. ¬øSu aceleraci√≥n?", options: ["1.5 m/s¬≤", "5 m/s¬≤", "2.5 m/s¬≤", "10 m/s¬≤"], correct: 2, difficulty: 2, topic: 'mrua', solution: "F√≥rmula: $a = \\frac{v - v_o}{t} \\rightarrow a = \\frac{15 - 5}{4} = 2.5 \\, m/s^2$" },
        { text: "Un objeto parte del reposo y acelera a $5 \\, m/s^2$ recorriendo 10m. ¬øSu velocidad final?", options: ["50 m/s", "10 m/s", "15 m/s", "2 m/s"], correct: 1, difficulty: 2, topic: 'mrua', solution: "F√≥rmula: $v^2 = v_o^2 + 2ax \\rightarrow v^2 = 0 + 2(5)(10) = 100 \\rightarrow v = 10 \\, m/s$" },
        { text: "Un m√≥vil parte con $v_o=2m/s$ y $a=4m/s^2$. ¬øDistancia en 3s?", options: ["18 m", "30 m", "24 m", "12 m"], correct: 2, difficulty: 3, topic: 'mrua', solution: "F√≥rmula: $x = v_o t + \\frac{1}{2}at^2 \\rightarrow x = (2)(3) + \\frac{1}{2}(4)(3^2) = 24 \\, m$" },
        { text: "Un coche frena desde $25 m/s$ hasta detenerse en 5s. ¬øDistancia de frenado?", options: ["125 m", "62.5 m", "5 m", "25 m"], correct: 1, difficulty: 3, topic: 'mrua', solution: "F√≥rmula: $x = \\frac{(v + v_o)t}{2} \\rightarrow x = \\frac{(0+25)5}{2} = 62.5 \\, m$" },
        { text: "Se deja caer un objeto ($v_o=0$) desde una torre. ¬øQu√© distancia recorre en 2s? ($g \\approx 10 m/s^2$)", options: ["10 m", "20 m", "40 m", "5 m"], correct: 1, difficulty: 2, topic: 'vertical', solution: "F√≥rmula: $y = v_o t + \\frac{1}{2}gt^2 \\rightarrow y = 0 + \\frac{1}{2}(10)(2^2) = 20 \\, m$" },
        { text: "Un objeto lanzado hacia arriba con $30 m/s$, ¬øqu√© altura m√°xima alcanza? ($g \\approx 10 m/s^2$)", options: ["30 m", "90 m", "45 m", "15 m"], correct: 2, difficulty: 3, topic: 'vertical', solution: "En altura max, $v=0$. F√≥rmula: $v^2 = v_o^2 + 2gy \\rightarrow y = \\frac{-v_o^2}{2g} = \\frac{-30^2}{2(-10)} = 45 \\, m$" },
        { text: "Un CD gira con una rapidez angular de 20 rad/s. ¬øCu√°l es su velocidad tangencial en un punto a 0.05 m del centro?", options: ["1 m/s", "400 m/s", "0.25 m/s", "10 m/s"], correct: 0, difficulty: 2, topic: 'circular', solution: "F√≥rmula: $v = \\omega \\cdot r \\rightarrow v = 20 \\, rad/s \\cdot 0.05 \\, m = 1 \\, m/s$"},
        { text: "En un MCU, la aceleraci√≥n centr√≠peta apunta...", options: ["Hacia afuera del c√≠rculo", "En la direcci√≥n del movimiento", "Hacia el centro del c√≠rculo", "Es nula"], correct: 2, difficulty: 1, topic: 'circular', solution: "La aceleraci√≥n centr√≠peta es responsable de cambiar la direcci√≥n del vector velocidad, manteni√©ndolo en una trayectoria circular, y siempre apunta hacia el centro."},
        { text: "Un proyectil se lanza con $v_x=30m/s$ y $v_y=40m/s$. ¬øTiempo para alcanzar la altura m√°xima? ($g \\approx 10 m/s^2$)", options: ["3 s", "4 s", "7 s", "10 s"], correct: 1, difficulty: 3, topic: 'parabolico', solution: "En la altura m√°xima, $v_y=0$. F√≥rmula: $v_y = v_{oy} + gt \\rightarrow t = -v_{oy}/g = -40/(-10) = 4 \\, s$" },
        { text: "En el movimiento parab√≥lico, ¬øqu√© componente de la velocidad es constante (sin fricci√≥n)?", options: ["La vertical", "Ambas", "Ninguna", "La horizontal"], correct: 3, difficulty: 1, topic: 'parabolico', solution: "Sin resistencia del aire, no hay fuerzas horizontales, por lo que la componente horizontal de la velocidad ($v_x$) permanece constante." },
    ];
    const curiosities = [
        { title: "Constante de Gravitaci√≥n", text: "La constante $G$ es aprox. $6.674 \\times 10^{-11} \\, N(m/kg)^2$. ¬°Mantiene unidos a los planetas!"},
        { title: "Velocidad de la Luz", text: "La velocidad de la luz en el vac√≠o ($c$) es la m√°xima posible: ¬°casi 300,000 km/s!"},
        { title: "Pista MRU", text: "En el Movimiento Rectil√≠neo Uniforme, la velocidad es constante. La aceleraci√≥n es siempre cero."},
        { title: "Pista MRUA", text: "En el Movimiento Uniformemente Acelerado, la aceleraci√≥n es constante. ¬°La velocidad cambia a un ritmo fijo!"},
        { title: "Escalar vs. Vectorial", text: "Una magnitud escalar (como la masa) solo tiene valor. Una vectorial (como la fuerza) tiene valor y direcci√≥n."},
        { title: "Inercia (1¬™ Ley de Newton)", text: "Un objeto en movimiento tiende a seguir en movimiento. ¬°Por eso necesitas cintur√≥n de seguridad!"},
        { title: "F√≥rmula M√°gica", text: "Una de las f√≥rmulas m√°s √∫tiles del MRUA es $v^2 = v_o^2 + 2ax$. Permite hallar velocidad o distancia sin saber el tiempo."},
    ];
    const levelConfig = { 1: { questions: 10, difficulties: [1, 2] }, 2: { questions: 15, difficulties: [1, 2, 3] }, 3: { questions: 20, difficulties: [1, 2, 3] } };
    let gameState = {};
    let soundManager = {};
    const topics = {
        magnitudes: "Magnitudes y S.I.",
        cinematica: "Cinem√°tica",
        mru: "MRU",
        mrua: "MRUA",
        vertical: "M. Vertical",
        circular: "M. Circular",
        parabolico: "M. Parab√≥lico"
    };

    // =======================================================================
    //  BLOQUE 2: L√ìGICA DEL JUEGO Y SONIDO
    // =======================================================================
    function initSound() {
        soundManager.click = new Tone.MembraneSynth({ pitchDecay: 0.01, octaves: 2, envelope: { attack: 0.001, decay: 0.2, sustain: 0 } }).toDestination();
        soundManager.correct = new Tone.PolySynth(Tone.Synth, { oscillator: { type: "sine" }, envelope: { attack: 0.01, decay: 0.2, sustain: 0.1, release: 0.2 } }).toDestination();
        soundManager.incorrect = new Tone.FMSynth({ harmonicity: 1.2, modulationIndex: 10, detune: 0, oscillator: { type: "square" }, envelope: { attack: 0.01, decay: 0.2, sustain: 0, release: 0.2 }, modulation: { type: "sawtooth" }, modulationEnvelope: { attack: 0.1, decay: 0.1, sustain: 0, release: 0.1 } }).toDestination();
        soundManager.start = soundManager.correct;
        soundManager.collision = new Tone.MetalSynth({ frequency: 50, envelope: { attack: 0.01, decay: 0.1, release: 0.1 }, harmonicity: 3.1, modulationIndex: 16, resonance: 2000, octaves: 0.5 }).toDestination();
    }
    function playSound(sound) {
        if (Tone.context.state !== 'running') { Tone.context.resume().then(initSound); return; }
        if (!soundManager.click) initSound();
        const now = Tone.now();
        switch(sound) {
            case 'click': soundManager.click.triggerAttackRelease('C4', '8n', now); break;
            case 'correct': soundManager.correct.triggerAttackRelease(['C5', 'E5', 'G5'], '16n', now); break;
            case 'incorrect': soundManager.incorrect.triggerAttackRelease('C3', '4n', now); break;
            case 'start': soundManager.start.triggerAttackRelease(['C4', 'G4', 'C5'], '8n', now); break;
            case 'collision': soundManager.collision.triggerAttackRelease('8n', now, 0.8); break;
        }
    }
    function resetGameState() { gameState = { level: 1, lives: 5, score: 0, questionNumber: 0, totalCorrect: 0, totalAnswered: 0, isPaused: false, levelQuestions: [], isGameOver: false, }; }
    function startGame(level, selectedTopics) {
        if (selectedTopics.length === 0) {
            alert("Por favor, selecciona al menos un tema para empezar.");
            return;
        }
        playSound('start');
        resetGameState();
        gameState.level = level;
        const requiredDifficulties = levelConfig[level].difficulties;
        const questionPool = questions.filter(q => 
            selectedTopics.includes(q.topic) && requiredDifficulties.includes(q.difficulty)
        );
        if (questionPool.length === 0) {
            alert("No hay preguntas disponibles para la combinaci√≥n de tema y nivel seleccionada. Por favor, elige otras opciones.");
            return;
        }
        gameState.levelQuestions = shuffleArray(questionPool).slice(0, levelConfig[level].questions);
        document.getElementById('start-screen').style.display = 'none';
        document.getElementById('quiz-area').style.display = 'flex';
        document.getElementById('stats-bar').style.display = 'flex';
        document.getElementById('controls-bar').style.display = 'flex';
        updateUI();
        nextQuestion();
    }
    function nextQuestion() {
        if (gameState.isGameOver) return;
        if (gameState.questionNumber >= gameState.levelQuestions.length) { endLevel(); return; }
        const q = gameState.levelQuestions[gameState.questionNumber];
        document.getElementById('question-text').innerHTML = q.text;
        const optionsContainer = document.getElementById('options-container');
        optionsContainer.innerHTML = '';
        q.options.forEach((opt, idx) => {
            const btn = document.createElement('button');
            btn.className = 'option-button';
            btn.innerHTML = opt;
            btn.onclick = () => { playSound('click'); checkAnswer(idx); };
            optionsContainer.appendChild(btn);
        });
        MathJax.typesetPromise();
        updateUI();
    }
    function checkAnswer(selectedIndex) {
        const q = gameState.levelQuestions[gameState.questionNumber];
        const options = document.getElementById('options-container').children;
        for (let btn of options) { btn.disabled = true; }
        gameState.totalAnswered++;
        let isCorrect = selectedIndex === q.correct;
        let title, text;
        if (isCorrect) {
            playSound('correct');
            title = "‚úÖ ¬°Correcto! üéâ"; text = "¬°Excelente! Sumas +100 puntos.";
            gameState.score += 100; gameState.totalCorrect++;
            options[selectedIndex].classList.add('correct');
        } else {
            playSound('incorrect');
            title = "‚ùå ¬°Incorrecto! üíî"; text = "Error en los c√°lculos. Pierdes una vida.";
            gameState.lives--;
            options[selectedIndex].classList.add('incorrect');
            options[q.correct].classList.add('correct');
        }
        gameState.questionNumber++;
        setTimeout(() => {
            if (gameState.lives <= 0) { gameOver(); } 
            else { showFeedbackModal(title, text, q.solution); }
        }, 1200);
    }
    
    function getPerformanceMessage(grade) {
        if (grade >= 4.5) return "<h4>Mensaje del Comando Estelar:</h4><p>¬°Extraordinario! Demuestras un dominio total del cosmos. Eres una leyenda de la f√≠sica.</p>";
        if (grade >= 3.5) return "<h4>Mensaje del Comando Estelar:</h4><p>¬°Muy bien hecho, piloto! Tus habilidades son impresionantes. Sigue as√≠.</p>";
        if (grade >= 2.5) return "<h4>Mensaje del Comando Estelar:</h4><p>¬°Buen esfuerzo! Est√°s en el camino correcto. La pr√°ctica te har√° un maestro.</p>";
        return "<h4>Mensaje del Comando Estelar:</h4><p>La galaxia es un lugar desafiante. ¬°No te rindas! Cada error es una oportunidad para aprender.</p>";
    }

    function endLevel() {
        playSound('start');
        const finalGrade = (gameState.totalCorrect / gameState.totalAnswered) * 5 || 0;
        const title = `üèÅ ¬°Nivel ${gameState.level} Completado! üèÅ`;
        const stats = `Puntuaci√≥n: ${gameState.score} | Precisi√≥n: ${((gameState.totalCorrect / gameState.totalAnswered) * 100 || 0).toFixed(0)}% | Nota Final: ${finalGrade.toFixed(1)}`;
        const message = getPerformanceMessage(finalGrade);
        let text, btnText;
        if (levelConfig[gameState.level + 1]) {
            text = "¬øListo para el siguiente desaf√≠o?"; btnText = `Ir al Nivel ${gameState.level + 1}`;
            document.getElementById('end-level-button').onclick = () => { hideEndLevelModal(); startGame(gameState.level + 1, getSelectedTopics()); };
        } else {
            text = "¬°FELICITACIONES! Has completado todas las misiones."; btnText = "Volver al Inicio";
            document.getElementById('end-level-button').onclick = () => location.reload();
            gameState.isGameOver = true;
        }
        showEndLevelModal(title, text, stats, message, btnText);
    }

    function gameOver() {
        playSound('incorrect');
        gameState.isGameOver = true;
        const finalGrade = (gameState.totalCorrect / gameState.totalAnswered) * 5 || 0;
        const title = "üí• GAME OVER üí•";
        const text = "Te has quedado sin vidas. ¬°Pero puedes volver a intentarlo!";
        const stats = `Nivel: ${gameState.level} | Puntuaci√≥n: ${gameState.score} | Nota Final: ${finalGrade.toFixed(1)}`;
        const message = getPerformanceMessage(finalGrade);
        const btnText = "Reiniciar Juego";
        document.getElementById('end-level-button').onclick = () => location.reload();
        showEndLevelModal(title, text, stats, message, btnText);
    }
    function shuffleArray(a) { for (let i = a.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [a[i], a[j]] = [a[j], a[i]]; } return a; }

    // =======================================================================
    //  BLOQUE 3: MANEJO DE UI (MODALES Y ESTAD√çSTICAS)
    // =======================================================================
    function isModalActive() {
        const modals = document.querySelectorAll('.modal');
        for (let modal of modals) {
            if (modal.style.display === 'flex') return true;
        }
        return false;
    }
    function updateUI() {
        if (!gameState.level) return;
        document.getElementById('level-display').textContent = gameState.level;
        document.getElementById('lives-display').textContent = '‚ù§Ô∏è'.repeat(gameState.lives) + 'üñ§'.repeat(Math.max(0, 5 - gameState.lives));
        document.getElementById('score-display').textContent = gameState.score;
        document.getElementById('progress-display').textContent = `${gameState.questionNumber}/${gameState.levelQuestions.length}`;
        const grade = gameState.totalAnswered === 0 ? 0 : (gameState.totalCorrect / gameState.totalAnswered) * 5;
        document.getElementById('grade-display').textContent = grade.toFixed(1);
    }
    function showFeedbackModal(title, text, solution) {
        document.getElementById('feedback-title').innerHTML = title;
        document.getElementById('feedback-text').innerHTML = text;
        const solContainer = document.getElementById('solution-container');
        solContainer.innerHTML = `<h4>Soluci√≥n:</h4><p>${solution}</p>`;
        MathJax.typesetPromise([solContainer]);
        document.getElementById('feedback-modal').style.display = 'flex';
    }
    function hideFeedbackModal() { document.getElementById('feedback-modal').style.display = 'none'; nextQuestion(); }
    function showEndLevelModal(title, text, stats, message, btnText) {
        document.getElementById('end-level-title').textContent = title;
        document.getElementById('end-level-text').textContent = text;
        document.getElementById('end-level-stats').textContent = stats;
        document.getElementById('final-message-container').innerHTML = message;
        document.getElementById('end-level-button').textContent = btnText;
        document.getElementById('end-level-modal').style.display = 'flex';
    }
    function hideEndLevelModal() { document.getElementById('end-level-modal').style.display = 'none'; }
    function togglePause() { playSound('click'); gameState.isPaused = !gameState.isPaused; document.getElementById('pause-modal').style.display = gameState.isPaused ? 'flex' : 'none'; }
    function showCuriosityModal() {
        playSound('collision');
        const curiosity = curiosities[Math.floor(Math.random() * curiosities.length)];
        const container = document.getElementById('curiosity-container');
        container.innerHTML = `<h4>${curiosity.title}</h4><p>${curiosity.text}</p>`;
        MathJax.typesetPromise([container]);
        document.getElementById('curiosity-modal').style.display = 'flex';
    }
    function hideCuriosityModal() { playSound('click'); document.getElementById('curiosity-modal').style.display = 'none'; }

    // =======================================================================
    //  BLOQUE 4: ANIMACI√ìN DE FONDO INTERACTIVA (CANVAS)
    // =======================================================================
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    let movingAsteroids = [], staticGalaxy = [], playerShip = { x: 0, y: 0, vx: 0, vy: 0, angle: 0, size: 40, target: {x: 0, y: 0}, maxSpeed: 1.8, thrust: 0.04 }, lastCollisionTime = 0;
    let explosions = [];

    function createAsteroid() {
        const size = Math.random() * 25 + 15;
        return { x: canvas.width + size, y: Math.random() * canvas.height, size: size, speed: Math.random() * 1.5 + 0.5, emoji: '‚òÑÔ∏è', angle: 0, rotationSpeed: (Math.random() - 0.5) * 0.02 };
    }

    function createGalaxyObject() {
        return { x: Math.random() * canvas.width, y: Math.random() * canvas.height, size: Math.random() * 20 + 10,
            hasRings: Math.random() > 0.8,
            color: `hsl(${Math.random() * 360}, 70%, 60%)`
        };
    }
    
    function createExplosion(x, y) {
        for (let i = 0; i < 20; i++) {
            explosions.push({
                x: x,
                y: y,
                vx: (Math.random() - 0.5) * 4,
                vy: (Math.random() - 0.5) * 4,
                life: 1,
                color: `hsl(${Math.random() * 60}, 100%, 50%)`
            });
        }
    }

    function setupCanvas() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        
        playerShip.x = canvas.width / 4;
        playerShip.y = canvas.height / 2;
        playerShip.vx = 0;
        playerShip.vy = 0;
        playerShip.angle = -Math.PI / 2;
        setNewShipTarget();

        movingAsteroids = Array.from({ length: 8 }, createAsteroid);
        staticGalaxy = [
            ...Array.from({ length: 15 }, () => ({...createGalaxyObject(), emoji: '‚ú®'})),
            ...Array.from({ length: 15 }, () => ({...createGalaxyObject(), emoji: '‚≠ê'})),
            ...Array.from({ length: 5 }, createGalaxyObject), 
        ];
    }

    function setNewShipTarget() {
        playerShip.target.x = Math.random() * canvas.width * 0.8 + canvas.width * 0.1; 
        playerShip.target.y = Math.random() * canvas.height * 0.8 + canvas.height * 0.1;
    }

    function updateAndDrawPlayerShip() {
        const dx = playerShip.target.x - playerShip.x;
        const dy = playerShip.target.y - playerShip.y;
        const dist = Math.hypot(dx, dy);

        const angleToTarget = Math.atan2(dy, dx);
        playerShip.vx += Math.cos(angleToTarget) * playerShip.thrust;
        playerShip.vy += Math.sin(angleToTarget) * playerShip.thrust;

        playerShip.vx *= 0.985;
        playerShip.vy *= 0.985;

        const speed = Math.hypot(playerShip.vx, playerShip.vy);
        if (speed > playerShip.maxSpeed) {
            playerShip.vx = (playerShip.vx / speed) * playerShip.maxSpeed;
            playerShip.vy = (playerShip.vy / speed) * playerShip.maxSpeed;
        }

        playerShip.x += playerShip.vx;
        playerShip.y += playerShip.vy;
        
        if (dist < 100) {
            setNewShipTarget();
        }

        const targetAngle = Math.atan2(playerShip.vy, playerShip.vx) + Math.PI / 2;
        let angleDiff = targetAngle - playerShip.angle;
        while (angleDiff < -Math.PI) angleDiff += 2 * Math.PI;
        while (angleDiff > Math.PI) angleDiff -= 2 * Math.PI;
        playerShip.angle += angleDiff * 0.1;

        ctx.save();
        ctx.translate(playerShip.x, playerShip.y);
        ctx.rotate(playerShip.angle);
        ctx.font = `${playerShip.size}px sans-serif`;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText('üöÄ', 0, 0);
        ctx.restore();
    }
    
    function drawGalaxyBackground() {
        staticGalaxy.forEach(obj => {
            ctx.save();
            const parallaxX = (playerShip.x - canvas.width / 2) * -0.01;
            const parallaxY = (playerShip.y - canvas.height / 2) * -0.01;
            ctx.translate(obj.x + parallaxX, obj.y + parallaxY);
            
            if (obj.emoji) {
                 ctx.font = `${obj.size}px sans-serif`;
                 ctx.textAlign = 'center';
                 ctx.textBaseline = 'middle';
                 ctx.fillText(obj.emoji, 0, 0);
            } else {
                ctx.fillStyle = obj.color;
                ctx.beginPath();
                ctx.arc(0, 0, obj.size / 2, 0, Math.PI * 2);
                ctx.fill();
                if(obj.hasRings) {
                    ctx.strokeStyle = `rgba(255, 255, 255, 0.7)`;
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.scale(1, 0.4);
                    ctx.arc(0, 0, obj.size, 0, Math.PI * 2);
                    ctx.stroke();
                }
            }
            ctx.restore();
        });
    }

    function drawMovingAsteroids() {
        movingAsteroids.forEach(obj => {
            obj.x -= obj.speed;
            if (obj.x < -obj.size) { obj.x = canvas.width + obj.size; obj.y = Math.random() * canvas.height; }
            ctx.save();
            ctx.translate(obj.x, obj.y);
            ctx.rotate(obj.angle += obj.rotationSpeed);
            ctx.font = `${obj.size}px sans-serif`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(obj.emoji, 0, 0);
            ctx.restore();
        });
    }
    
    function updateAndDrawExplosions() {
        for (let i = explosions.length - 1; i >= 0; i--) {
            const p = explosions[i];
            p.x += p.vx;
            p.y += p.vy;
            p.life -= 0.04;
            if (p.life <= 0) {
                explosions.splice(i, 1);
            } else {
                ctx.globalAlpha = p.life;
                ctx.fillStyle = p.color;
                ctx.beginPath();
                ctx.arc(p.x, p.y, 2, 0, Math.PI * 2);
                ctx.fill();
            }
        }
        ctx.globalAlpha = 1;
    }

    function checkCollisions() {
        const now = Date.now();
        if (now - lastCollisionTime < 10000) return; 
        
        movingAsteroids.forEach(obj => {
            const dist = Math.hypot(playerShip.x - obj.x, playerShip.y - obj.y);
            if (dist < obj.size / 2 + playerShip.size / 2) {
                lastCollisionTime = now;
                createExplosion(obj.x, obj.y);
                showCuriosityModal();
                obj.x = canvas.width + obj.size;
            }
        });
    }

    function animate() {
        requestAnimationFrame(animate);
        if (gameState.isPaused) return;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        drawGalaxyBackground();
        updateAndDrawPlayerShip();
        drawMovingAsteroids();
        updateAndDrawExplosions();
        
        if (gameState.level && !isModalActive()) {
            checkCollisions();
        }
    }
    
    // =======================================================================
    //  BLOQUE 5: EVENT LISTENERS
    // =======================================================================
    function getSelectedTopics() {
        const selected = [];
        document.querySelectorAll('#topic-selection-grid input:checked').forEach(input => {
            selected.push(input.value);
        });
        return selected;
    }

    function setupStartScreen() {
        const topicGrid = document.getElementById('topic-selection-grid');
        topicGrid.innerHTML = '';
        for (const [key, value] of Object.entries(topics)) {
            const label = document.createElement('label');
            label.className = 'checkbox-container';
            label.innerHTML = `
                <input type="checkbox" value="${key}" checked>
                <span class="checkmark"></span>
                <span>${value}</span>
            `;
            topicGrid.appendChild(label);
        }

        document.querySelectorAll('.level-btn').forEach(button => {
            button.onclick = (e) => {
                const level = parseInt(e.target.dataset.level);
                const selectedTopics = getSelectedTopics();
                startGame(level, selectedTopics);
            };
        });
    }

    window.addEventListener('resize', setupCanvas);
    document.getElementById('pause-button').addEventListener('click', togglePause);
    document.getElementById('help-button').addEventListener('click', () => { playSound('click'); document.getElementById('help-modal').style.display = 'flex'; });
    document.getElementById('restart-button').addEventListener('click', () => { playSound('click'); document.getElementById('confirm-modal').style.display = 'flex'; });

    // =======================================================================
    //  BLOQUE 6: INICIALIZACI√ìN
    // =======================================================================
    setupCanvas();
    setupStartScreen();
    animate();
    document.body.addEventListener('click', () => playSound('click'), { once: true });
    </script>
</body>
</html>
